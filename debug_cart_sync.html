<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Debug Cart Sync</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .debug-section { margin: 20px 0; padding: 15px; border: 1px solid #ddd; }
        button { margin: 5px; padding: 10px; background: #007AFF; color: white; border: none; border-radius: 4px; cursor: pointer; }
        .result { background: #f5f5f5; padding: 10px; margin: 10px 0; border-radius: 4px; font-family: monospace; white-space: pre-wrap; }
        .success { background: #d4edda; color: #155724; }
        .error { background: #f8d7da; color: #721c24; }
    </style>
</head>
<body>
    <h1>üîç Debug Cart Sync Issue</h1>
    
    <div class="debug-section">
        <h3>Step 1: Setup Test Environment</h3>
        <button onclick="setupTestData()">Setup Test Data</button>
        <button onclick="clearAllData()">Clear All Data</button>
        <div id="setupResult" class="result"></div>
    </div>
    
    <div class="debug-section">
        <h3>Step 2: Check Current State</h3>
        <button onclick="checkCurrentState()">Check Current State</button>
        <div id="stateResult" class="result"></div>
    </div>
    
    <div class="debug-section">
        <h3>Step 3: Simulate Login Process</h3>
        <button onclick="simulateLogin()">Simulate Login</button>
        <button onclick="checkAfterLogin()">Check After Login</button>
        <div id="loginResult" class="result"></div>
    </div>
    
    <div class="debug-section">
        <h3>Step 4: Manual Sync Test</h3>
        <button onclick="manualSync()">Manual Sync</button>
        <div id="syncResult" class="result"></div>
    </div>

    <script>
        function setupTestData() {
            // Clear everything first
            localStorage.clear();
            
            // Setup guest cart with test items
            const guestItems = [
                {
                    id: Date.now(),
                    productId: 1,
                    name: "Test Product 1",
                    price: 25000,
                    quantity: 2,
                    image: "test1.jpg",
                    stock: 100
                },
                {
                    id: Date.now() + 1,
                    productId: 2,
                    name: "Test Product 2", 
                    price: 15000,
                    quantity: 1,
                    image: "test2.jpg",
                    stock: 50
                }
            ];
            
            localStorage.setItem('guestCart', JSON.stringify(guestItems));
            localStorage.setItem('guestCartTimestamp', Date.now().toString());
            
            document.getElementById('setupResult').innerHTML = 
                `‚úÖ Test data setup complete:\n- Guest cart: ${guestItems.length} items\n- No user logged in\n- No sync flags`;
        }
        
        function clearAllData() {
            localStorage.clear();
            document.getElementById('setupResult').innerHTML = '‚úÖ All data cleared';
            document.getElementById('stateResult').innerHTML = '';
            document.getElementById('loginResult').innerHTML = '';
            document.getElementById('syncResult').innerHTML = '';
        }
        
        function checkCurrentState() {
            const guestCart = localStorage.getItem('guestCart');
            const user = localStorage.getItem('user');
            const token = localStorage.getItem('token');
            const syncFlags = Object.keys(localStorage).filter(key => key.startsWith('cartSynced_'));
            
            let result = 'CURRENT STATE:\\n\\n';\n            result += `Guest Cart: ${guestCart ? 'EXISTS' : 'EMPTY'}\\n`;\n            \n            if (guestCart) {\n                const items = JSON.parse(guestCart);\n                result += `  - Items: ${items.length}\\n`;\n                items.forEach((item, index) => {\n                    result += `  - Item ${index + 1}: ${item.name} (qty: ${item.quantity})\\n`;\n                });\n            }\n            \n            result += `\\nUser: ${user ? 'LOGGED IN' : 'NOT LOGGED IN'}\\n`;\n            if (user) {\n                const userData = JSON.parse(user);\n                result += `  - ID: ${userData.id}\\n`;\n                result += `  - Name: ${userData.name}\\n`;\n            }\n            \n            result += `\\nToken: ${token ? 'EXISTS' : 'NONE'}\\n`;\n            result += `Sync Flags: ${syncFlags.length}\\n`;\n            syncFlags.forEach(flag => {\n                result += `  - ${flag}\\n`;\n            });\n            \n            document.getElementById('stateResult').innerHTML = result;\n        }\n        \n        function simulateLogin() {\n            const testUser = {\n                id: 123,\n                name: 'Test User',\n                email: 'test@example.com',\n                role: 'USER'\n            };\n            \n            const testToken = 'test-token-' + Date.now();\n            const expiration = Date.now() + (24 * 60 * 60 * 1000); // 24 hours\n            \n            // Store auth data\n            localStorage.setItem('user', JSON.stringify(testUser));\n            localStorage.setItem('token', testToken);\n            localStorage.setItem('tokenExpiration', expiration.toString());\n            \n            // Check what should happen\n            const guestCart = localStorage.getItem('guestCart');\n            const syncKey = `cartSynced_${testUser.id}`;\n            const alreadySynced = localStorage.getItem(syncKey);\n            \n            let result = 'LOGIN SIMULATION:\\n\\n';\n            result += `‚úÖ User logged in: ${testUser.name} (ID: ${testUser.id})\\n`;\n            result += `‚úÖ Token stored: ${testToken.substring(0, 20)}...\\n\\n`;\n            \n            result += 'SYNC CONDITIONS:\\n';\n            result += `- Guest cart exists: ${!!guestCart}\\n`;\n            result += `- Already synced: ${!!alreadySynced}\\n`;\n            result += `- Should sync: ${!!(guestCart && !alreadySynced)}\\n\\n`;\n            \n            if (guestCart && !alreadySynced) {\n                const items = JSON.parse(guestCart);\n                result += `ITEMS TO SYNC (${items.length}):\\n`;\n                items.forEach((item, index) => {\n                    result += `${index + 1}. ${item.name} - Qty: ${item.quantity}\\n`;\n                });\n            }\n            \n            document.getElementById('loginResult').innerHTML = result;\n        }\n        \n        function checkAfterLogin() {\n            const guestCart = localStorage.getItem('guestCart');\n            const user = localStorage.getItem('user');\n            const syncFlags = Object.keys(localStorage).filter(key => key.startsWith('cartSynced_'));\n            \n            let result = 'AFTER LOGIN CHECK:\\n\\n';\n            \n            if (!user) {\n                result += '‚ùå No user found - login simulation failed\\n';\n            } else {\n                const userData = JSON.parse(user);\n                result += `‚úÖ User: ${userData.name} (ID: ${userData.id})\\n`;\n                \n                const syncKey = `cartSynced_${userData.id}`;\n                const isSynced = localStorage.getItem(syncKey);\n                \n                result += `Sync status: ${isSynced ? 'SYNCED' : 'NOT SYNCED'}\\n`;\n                result += `Guest cart: ${guestCart ? 'STILL EXISTS' : 'CLEARED'}\\n\\n`;\n                \n                if (guestCart && !isSynced) {\n                    result += '‚ùå PROBLEM: Guest cart exists but not synced\\n';\n                    result += 'This means sync process failed or didn\\'t run\\n';\n                } else if (!guestCart && isSynced) {\n                    result += '‚úÖ GOOD: Guest cart cleared and sync flag set\\n';\n                    result += 'Sync process completed successfully\\n';\n                } else if (guestCart && isSynced) {\n                    result += '‚ö†Ô∏è WEIRD: Sync flag set but guest cart not cleared\\n';\n                } else {\n                    result += '‚ö†Ô∏è No guest cart to sync\\n';\n                }\n            }\n            \n            document.getElementById('loginResult').innerHTML = result;\n        }\n        \n        function manualSync() {\n            const guestCart = localStorage.getItem('guestCart');\n            const user = localStorage.getItem('user');\n            \n            if (!user) {\n                document.getElementById('syncResult').innerHTML = '‚ùå No user logged in';\n                return;\n            }\n            \n            if (!guestCart) {\n                document.getElementById('syncResult').innerHTML = '‚ùå No guest cart to sync';\n                return;\n            }\n            \n            const userData = JSON.parse(user);\n            const guestItems = JSON.parse(guestCart);\n            const syncKey = `cartSynced_${userData.id}`;\n            \n            let result = 'MANUAL SYNC SIMULATION:\\n\\n';\n            result += `User ID: ${userData.id}\\n`;\n            result += `Items to sync: ${guestItems.length}\\n\\n`;\n            \n            // Simulate the sync process\n            result += 'SYNC PROCESS:\\n';\n            result += '1. Mark as synced and clear guest cart\\n';\n            \n            localStorage.setItem(syncKey, 'true');\n            localStorage.removeItem('guestCart');\n            localStorage.removeItem('guestCartTimestamp');\n            \n            result += '2. Simulate API calls for each item:\\n';\n            guestItems.forEach((item, index) => {\n                result += `   ${index + 1}. POST /api/cart/add {userId: ${userData.id}, productId: ${item.productId}, quantity: ${item.quantity}}\\n`;\n            });\n            \n            result += '\\n‚úÖ Manual sync completed\\n';\n            result += 'In real app, these would be actual API calls to backend\\n';\n            \n            document.getElementById('syncResult').innerHTML = result;\n        }\n        \n        // Auto-check state on load\n        window.onload = function() {\n            checkCurrentState();\n        };\n    </script>\n</body>\n</html>
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cart Duplication Test</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .test-section { margin: 20px 0; padding: 15px; border: 1px solid #ddd; }
        button { margin: 5px; padding: 10px; background: #007AFF; color: white; border: none; border-radius: 4px; cursor: pointer; }
        button:hover { background: #0056b3; }
        .result { background: #f5f5f5; padding: 10px; margin: 10px 0; border-radius: 4px; }
        .success { background: #d4edda; color: #155724; }
        .error { background: #f8d7da; color: #721c24; }
        .warning { background: #fff3cd; color: #856404; }
    </style>
</head>
<body>
    <h1>üîç Cart Duplication Prevention Test</h1>
    
    <div class="test-section">
        <h3>Step 1: Setup Guest Cart</h3>
        <button onclick="setupGuestCart()">Create Guest Cart (3 items)</button>
        <button onclick="viewCurrentCart()">View Current Cart</button>
        <div id="setupResult" class="result"></div>
    </div>
    
    <div class="test-section">
        <h3>Step 2: Simulate Login (Multiple Times)</h3>
        <button onclick="simulateLogin()">Simulate Login</button>
        <button onclick="simulateMultipleLogins()">Simulate Multiple Logins (5x)</button>
        <div id="loginResult" class="result"></div>
    </div>
    
    <div class="test-section">
        <h3>Step 3: Check for Duplication</h3>
        <button onclick="checkForDuplication()">Check Cart State</button>
        <button onclick="simulateBackendResponse()">Simulate Backend Response</button>
        <div id="duplicationResult" class="result"></div>
    </div>
    
    <div class="test-section">
        <h3>Step 4: Reset Test</h3>
        <button onclick="resetTest()">Reset All Data</button>
        <div id="resetResult" class="result"></div>
    </div>

    <script>
        let loginCount = 0;
        let syncAttempts = 0;
        
        function setupGuestCart() {\n            const testItems = [\n                { id: 1, productId: 1, name: \"Susu Ultra Milk\", price: 15000, quantity: 2, image: \"susu.jpg\", stock: 100 },\n                { id: 2, productId: 2, name: \"Roti Tawar\", price: 12000, quantity: 1, image: \"roti.jpg\", stock: 50 },\n                { id: 3, productId: 3, name: \"Kopi ABC\", price: 8000, quantity: 3, image: \"kopi.jpg\", stock: 200 }\n            ];\n            \n            localStorage.setItem('guestCart', JSON.stringify(testItems));\n            localStorage.setItem('guestCartTimestamp', Date.now().toString());\n            \n            // Clear any existing sync flags\n            Object.keys(localStorage).forEach(key => {\n                if (key.startsWith('cartSynced_')) {\n                    localStorage.removeItem(key);\n                }\n            });\n            \n            document.getElementById('setupResult').innerHTML = \n                `<div class=\"success\">‚úÖ Guest cart created with ${testItems.length} items</div>`;\n        }\n        \n        function viewCurrentCart() {\n            const guestCart = localStorage.getItem('guestCart');\n            const syncFlags = Object.keys(localStorage).filter(key => key.startsWith('cartSynced_'));\n            \n            let html = '<strong>Current Cart State:</strong><br>';\n            \n            if (guestCart) {\n                const items = JSON.parse(guestCart);\n                html += `Guest Cart: ${items.length} items<br>`;\n                items.forEach(item => {\n                    html += `‚Ä¢ ${item.name} (Qty: ${item.quantity})<br>`;\n                });\n            } else {\n                html += 'Guest Cart: Empty<br>';\n            }\n            \n            html += `<br>Sync Flags: ${syncFlags.length}<br>`;\n            syncFlags.forEach(flag => {\n                html += `‚Ä¢ ${flag}<br>`;\n            });\n            \n            document.getElementById('setupResult').innerHTML = html;\n        }\n        \n        function simulateLogin() {\n            loginCount++;\n            const userId = 123;\n            \n            // Simulate user login\n            const mockUser = {\n                id: userId,\n                name: `Test User ${loginCount}`,\n                email: 'test@example.com'\n            };\n            \n            localStorage.setItem('user', JSON.stringify(mockUser));\n            localStorage.setItem('token', `mock-token-${Date.now()}`);\n            localStorage.setItem('tokenExpiration', (Date.now() + 86400000).toString());\n            \n            // Check if sync should happen\n            const guestCart = localStorage.getItem('guestCart');\n            const syncFlag = localStorage.getItem(`cartSynced_${userId}`);\n            \n            let syncWillHappen = false;\n            if (guestCart && !syncFlag) {\n                syncWillHappen = true;\n                syncAttempts++;\n                \n                // Simulate sync process\n                localStorage.setItem(`cartSynced_${userId}`, 'true');\n                localStorage.removeItem('guestCart');\n                localStorage.removeItem('guestCartTimestamp');\n            }\n            \n            document.getElementById('loginResult').innerHTML = \n                `<div class=\"${syncWillHappen ? 'success' : 'warning'}\">\n                    Login #${loginCount} completed<br>\n                    Sync ${syncWillHappen ? 'WILL' : 'WILL NOT'} happen<br>\n                    Total sync attempts: ${syncAttempts}\n                </div>`;\n        }\n        \n        function simulateMultipleLogins() {\n            const startingSyncAttempts = syncAttempts;\n            \n            // Simulate rapid multiple logins (like what might happen with multiple event triggers)\n            for (let i = 0; i < 5; i++) {\n                setTimeout(() => {\n                    simulateLogin();\n                    \n                    if (i === 4) {\n                        const finalSyncAttempts = syncAttempts;\n                        const duplicateAttempts = finalSyncAttempts - startingSyncAttempts;\n                        \n                        document.getElementById('loginResult').innerHTML += \n                            `<br><div class=\"${duplicateAttempts <= 1 ? 'success' : 'error'}\">\n                                Multiple login test completed<br>\n                                Expected sync attempts: 1<br>\n                                Actual sync attempts: ${duplicateAttempts}<br>\n                                ${duplicateAttempts <= 1 ? '‚úÖ No duplication detected!' : '‚ùå Duplication detected!'}\n                            </div>`;\n                    }\n                }, i * 100);\n            }\n        }\n        \n        function checkForDuplication() {\n            const guestCart = localStorage.getItem('guestCart');\n            const syncFlags = Object.keys(localStorage).filter(key => key.startsWith('cartSynced_'));\n            const user = localStorage.getItem('user');\n            \n            let html = '<strong>Duplication Check Results:</strong><br>';\n            \n            // Check 1: Guest cart should be cleared after sync\n            if (user && !guestCart) {\n                html += '‚úÖ Guest cart properly cleared after login<br>';\n            } else if (user && guestCart) {\n                html += '‚ùå Guest cart still exists after login<br>';\n            } else {\n                html += '‚ö†Ô∏è No user logged in<br>';\n            }\n            \n            // Check 2: Only one sync flag per user\n            if (syncFlags.length <= 1) {\n                html += '‚úÖ Sync flag count is correct<br>';\n            } else {\n                html += `‚ùå Multiple sync flags detected: ${syncFlags.length}<br>`;\n            }\n            \n            // Check 3: Total sync attempts\n            html += `<br>Total sync attempts: ${syncAttempts}<br>`;\n            html += `Login attempts: ${loginCount}<br>`;\n            \n            if (syncAttempts <= 1 && loginCount > 0) {\n                html += '<div class=\"success\">‚úÖ Sync prevention working correctly!</div>';\n            } else if (syncAttempts > loginCount) {\n                html += '<div class=\"error\">‚ùå More syncs than logins - duplication detected!</div>';\n            } else {\n                html += '<div class=\"warning\">‚ö†Ô∏è Results inconclusive</div>';\n            }\n            \n            document.getElementById('duplicationResult').innerHTML = html;\n        }\n        \n        function simulateBackendResponse() {\n            // Simulate what would happen in the backend with duplicate requests\n            const mockCartItems = [\n                { productId: 1, quantity: 2 },\n                { productId: 2, quantity: 1 },\n                { productId: 3, quantity: 3 }\n            ];\n            \n            let backendCart = [];\n            \n            // Simulate multiple sync attempts (what we want to prevent)\n            for (let attempt = 1; attempt <= syncAttempts; attempt++) {\n                mockCartItems.forEach(item => {\n                    const existing = backendCart.find(cartItem => cartItem.productId === item.productId);\n                    if (existing) {\n                        existing.quantity += item.quantity; // This is what causes duplication!\n                    } else {\n                        backendCart.push({ ...item });\n                    }\n                });\n            }\n            \n            let html = '<strong>Simulated Backend Cart:</strong><br>';\n            html += `Sync attempts: ${syncAttempts}<br><br>`;\n            \n            backendCart.forEach(item => {\n                const expectedQty = item.productId === 1 ? 2 : item.productId === 2 ? 1 : 3;\n                const actualQty = item.quantity;\n                const isDuplicated = actualQty > expectedQty;\n                \n                html += `Product ${item.productId}: ${actualQty} ${isDuplicated ? '‚ùå' : '‚úÖ'} (expected: ${expectedQty})<br>`;\n            });\n            \n            const hasDuplication = backendCart.some(item => {\n                const expectedQty = item.productId === 1 ? 2 : item.productId === 2 ? 1 : 3;\n                return item.quantity > expectedQty;\n            });\n            \n            html += `<br><div class=\"${hasDuplication ? 'error' : 'success'}\">\n                ${hasDuplication ? '‚ùå Duplication would occur in backend!' : '‚úÖ No duplication in backend!'}\n            </div>`;\n            \n            document.getElementById('duplicationResult').innerHTML = html;\n        }\n        \n        function resetTest() {\n            // Clear all test data\n            localStorage.clear();\n            loginCount = 0;\n            syncAttempts = 0;\n            \n            document.getElementById('setupResult').innerHTML = '';\n            document.getElementById('loginResult').innerHTML = '';\n            document.getElementById('duplicationResult').innerHTML = '';\n            document.getElementById('resetResult').innerHTML = \n                '<div class=\"success\">‚úÖ All test data cleared. Ready for new test.</div>';\n        }\n        \n        // Auto-run initial setup\n        window.onload = function() {\n            document.getElementById('resetResult').innerHTML = \n                '<div class=\"warning\">‚ö†Ô∏è Ready to test cart duplication prevention</div>';\n        };\n    </script>\n</body>\n</html>
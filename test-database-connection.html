<!DOCTYPE html>
<html>
<head>
    <title>Database Connection Test</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .test-section { margin: 20px 0; padding: 15px; border: 1px solid #ddd; border-radius: 5px; }
        .success { background: #d4edda; border-color: #c3e6cb; }
        .error { background: #f8d7da; border-color: #f5c6cb; }
        .info { background: #d1ecf1; border-color: #bee5eb; }
        button { padding: 10px 15px; margin: 5px; background: #007bff; color: white; border: none; cursor: pointer; border-radius: 3px; }
        .result { margin-top: 10px; padding: 10px; border-radius: 3px; }
        .stats { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 10px; margin-top: 10px; }
        .stat-card { background: #f8f9fa; padding: 15px; border-radius: 5px; text-align: center; }
    </style>
</head>
<body>
    <h1>üîó Database Connection Test</h1>
    
    <div class="test-section info">
        <h3>üìä Connection Status</h3>
        <p><strong>Backend:</strong> <span id="backendStatus">Checking...</span></p>
        <p><strong>Database:</strong> <span id="databaseStatus">Checking...</span></p>
        <p><strong>Dashboard:</strong> <span id="dashboardStatus">Checking...</span></p>
    </div>

    <div class="test-section">
        <h3>1Ô∏è‚É£ Test Products Connection</h3>
        <button onclick="testProducts()">Test Products</button>
        <div id="productsResult" class="result"></div>
    </div>

    <div class="test-section">
        <h3>2Ô∏è‚É£ Test Categories Connection</h3>
        <button onclick="testCategories()">Test Categories</button>
        <div id="categoriesResult" class="result"></div>
    </div>

    <div class="test-section">
        <h3>3Ô∏è‚É£ Test Users Connection</h3>
        <button onclick="testUsers()">Test Users</button>
        <div id="usersResult" class="result"></div>
    </div>

    <div class="test-section">
        <h3>4Ô∏è‚É£ Test Dashboard Stats</h3>
        <button onclick="testDashboardStats()">Test Dashboard Stats</button>
        <div id="dashboardStatsResult" class="result"></div>
    </div>

    <div class="test-section">
        <h3>5Ô∏è‚É£ Test Add Product</h3>
        <button onclick="testAddProduct()">Test Add Product</button>
        <div id="addProductResult" class="result"></div>
    </div>

    <script>
        async function checkStatus() {
            // Check Backend
            try {
                const response = await fetch('http://localhost:8191/api/admin/products');
                document.getElementById('backendStatus').textContent = response.ok ? '‚úÖ Running' : '‚ùå Error';
                document.getElementById('backendStatus').style.color = response.ok ? 'green' : 'red';
            } catch (error) {
                document.getElementById('backendStatus').textContent = '‚ùå Not Running';
                document.getElementById('backendStatus').style.color = 'red';
            }

            // Check Dashboard
            try {
                const response = await fetch('http://localhost:3001');
                document.getElementById('dashboardStatus').textContent = response.ok ? '‚úÖ Running' : '‚ùå Error';
                document.getElementById('dashboardStatus').style.color = response.ok ? 'green' : 'red';
            } catch (error) {
                document.getElementById('dashboardStatus').textContent = '‚ùå Not Running';
                document.getElementById('dashboardStatus').style.color = 'red';
            }

            // Database status will be determined by API calls
            document.getElementById('databaseStatus').textContent = '‚è≥ Testing...';
        }

        async function testProducts() {
            const resultDiv = document.getElementById('productsResult');
            try {
                const response = await fetch('http://localhost:8191/api/admin/products');
                const result = await response.json();
                
                if (result.status) {
                    resultDiv.className = 'result success';
                    resultDiv.innerHTML = `
                        <h4>‚úÖ Products Connection Success!</h4>
                        <p><strong>Total Products:</strong> ${result.data.totalElements}</p>
                        <p><strong>Sample Products:</strong></p>
                        <ul>
                            ${result.data.products.slice(0, 3).map(product => 
                                `<li>${product.name} - Rp ${product.price}</li>`
                            ).join('')}
                        </ul>
                    `;
                    updateDatabaseStatus(true);
                } else {
                    resultDiv.className = 'result error';
                    resultDiv.innerHTML = `<h4>‚ùå Failed!</h4><p>${result.message}</p>`;
                    updateDatabaseStatus(false);
                }
            } catch (error) {
                resultDiv.className = 'result error';
                resultDiv.innerHTML = `<h4>‚ùå Network Error!</h4><p>${error.message}</p>`;
                updateDatabaseStatus(false);
            }
        }

        async function testCategories() {
            const resultDiv = document.getElementById('categoriesResult');
            try {
                const response = await fetch('http://localhost:8191/api/products/categories');
                const result = await response.json();
                
                if (result.status) {
                    resultDiv.className = 'result success';
                    resultDiv.innerHTML = `
                        <h4>‚úÖ Categories Connection Success!</h4>
                        <p><strong>Total Categories:</strong> ${result.data.categories.length}</p>
                        <p><strong>Categories:</strong></p>
                        <ul>
                            ${result.data.categories.slice(0, 5).map(cat => 
                                `<li>${cat.icon} ${cat.name}</li>`
                            ).join('')}
                        </ul>
                    `;
                } else {
                    resultDiv.className = 'result error';
                    resultDiv.innerHTML = `<h4>‚ùå Failed!</h4><p>${result.message}</p>`;
                }
            } catch (error) {
                resultDiv.className = 'result error';
                resultDiv.innerHTML = `<h4>‚ùå Network Error!</h4><p>${error.message}</p>`;
            }
        }

        async function testUsers() {
            const resultDiv = document.getElementById('usersResult');
            try {
                const response = await fetch('http://localhost:8191/api/admin/users');
                const result = await response.json();
                
                if (result.status) {
                    resultDiv.className = 'result success';
                    resultDiv.innerHTML = `
                        <h4>‚úÖ Users Connection Success!</h4>
                        <p><strong>Total Users:</strong> ${result.data.users.length}</p>
                        <p><strong>Users:</strong></p>
                        <ul>
                            ${result.data.users.map(user => 
                                `<li>${user.name} (${user.email}) - ${user.role}</li>`
                            ).join('')}
                        </ul>
                    `;
                } else {
                    resultDiv.className = 'result error';
                    resultDiv.innerHTML = `<h4>‚ùå Failed!</h4><p>${result.message}</p>`;
                }
            } catch (error) {
                resultDiv.className = 'result error';
                resultDiv.innerHTML = `<h4>‚ùå Network Error!</h4><p>${error.message}</p>`;
            }
        }

        async function testDashboardStats() {
            const resultDiv = document.getElementById('dashboardStatsResult');
            try {
                const response = await fetch('http://localhost:8191/api/admin/dashboard/stats');
                const result = await response.json();
                
                if (result.status) {
                    resultDiv.className = 'result success';
                    resultDiv.innerHTML = `
                        <h4>‚úÖ Dashboard Stats Success!</h4>
                        <div class="stats">
                            <div class="stat-card">
                                <h3>${result.data.totalProducts}</h3>
                                <p>Total Products</p>
                            </div>
                            <div class="stat-card">
                                <h3>${result.data.totalUsers}</h3>
                                <p>Total Users</p>
                            </div>
                            <div class="stat-card">
                                <h3>${result.data.lowStockProducts}</h3>
                                <p>Low Stock Products</p>
                            </div>
                            <div class="stat-card">
                                <h3>${result.data.totalOrders}</h3>
                                <p>Total Orders</p>
                            </div>
                        </div>
                    `;
                } else {
                    resultDiv.className = 'result error';
                    resultDiv.innerHTML = `<h4>‚ùå Failed!</h4><p>${result.message}</p>`;
                }
            } catch (error) {
                resultDiv.className = 'result error';
                resultDiv.innerHTML = `<h4>‚ùå Network Error!</h4><p>${error.message}</p>`;
            }
        }

        async function testAddProduct() {
            const resultDiv = document.getElementById('addProductResult');
            try {
                const productData = {
                    name: 'Test Connection Product - ' + new Date().toLocaleTimeString(),
                    price: 15000,
                    stock: 5,
                    category: 'Makanan',
                    image: 'https://images.unsplash.com/photo-1567620905732-2d1ec7ab7445?w=400'
                };

                const response = await fetch('http://localhost:8191/api/admin/products', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(productData)
                });
                
                const result = await response.json();
                if (result.status) {
                    resultDiv.className = 'result success';
                    resultDiv.innerHTML = `
                        <h4>‚úÖ Add Product Success!</h4>
                        <p><strong>Product ID:</strong> ${result.data.id}</p>
                        <p><strong>Name:</strong> ${result.data.namaBarang}</p>
                        <p><strong>Price:</strong> Rp ${result.data.hargaJual}</p>
                        <p><em>Product will be cleaned up automatically</em></p>
                    `;
                    
                    // Clean up test product
                    setTimeout(async () => {
                        try {
                            await fetch(`http://localhost:8191/api/admin/products/${result.data.id}`, {
                                method: 'DELETE'
                            });
                        } catch (e) {
                            console.log('Cleanup failed:', e);
                        }
                    }, 2000);
                } else {
                    resultDiv.className = 'result error';
                    resultDiv.innerHTML = `<h4>‚ùå Failed!</h4><p>${result.message}</p>`;
                }
            } catch (error) {
                resultDiv.className = 'result error';
                resultDiv.innerHTML = `<h4>‚ùå Network Error!</h4><p>${error.message}</p>`;
            }
        }

        function updateDatabaseStatus(isConnected) {
            const statusElement = document.getElementById('databaseStatus');
            statusElement.textContent = isConnected ? '‚úÖ Connected' : '‚ùå Connection Failed';
            statusElement.style.color = isConnected ? 'green' : 'red';
        }

        // Auto-run status check on page load
        window.onload = () => {
            checkStatus();
            setTimeout(testProducts, 1000);
        };
    </script>
</body>
</html>
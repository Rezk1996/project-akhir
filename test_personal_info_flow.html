<!DOCTYPE html>
<html>
<head>
    <title>Test Personal Info Flow</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .container { max-width: 800px; margin: 0 auto; }
        .section { margin: 20px 0; padding: 15px; border: 1px solid #ddd; border-radius: 5px; }
        .success { background: #d4edda; border-color: #c3e6cb; }
        .error { background: #f8d7da; border-color: #f5c6cb; }
        .info { background: #d1ecf1; border-color: #bee5eb; }
        button { background: #007bff; color: white; padding: 10px 15px; border: none; border-radius: 4px; cursor: pointer; margin: 5px; }
        button:hover { background: #0056b3; }
        .user-card { border: 1px solid #ddd; padding: 15px; margin: 10px 0; border-radius: 5px; }
        .profile-image { width: 60px; height: 60px; border-radius: 50%; object-fit: cover; margin-right: 15px; }
        .user-info { display: flex; align-items: center; }
        pre { background: #f8f9fa; padding: 10px; border-radius: 4px; overflow-x: auto; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üßë‚Äçüíº Personal Info Flow Test</h1>
        
        <div class="section info">
            <h3>üìã Test Flow:</h3>
            <ol>
                <li>Register new user on E-commerce</li>
                <li>Login and update personal info in My Profile</li>
                <li>Verify data appears in Dashboard Admin Users Management</li>
            </ol>
        </div>
        
        <div class="section">
            <h3>üîß Test Controls</h3>
            <button onclick="testFullFlow()">üöÄ Test Complete Flow</button>
            <button onclick="checkAdminUsers()">üë• Check Admin Users</button>
            <button onclick="clearResults()">üóëÔ∏è Clear Results</button>
        </div>
        
        <div id="results"></div>
    </div>

    <script>
        const API_BASE = 'http://localhost:8191/api';
        let testToken = null;
        let testUserId = null;
        
        async function testFullFlow() {
            const resultsDiv = document.getElementById('results');
            resultsDiv.innerHTML = '<div class="section info">üîÑ Running complete personal info flow test...</div>';\n            
            try {\n                // Step 1: Register user\n                await addResult('Step 1: Registering test user...', 'info');\n                const registerData = {\n                    name: 'John Doe Test',\n                    email: `testuser${Date.now()}@example.com`,\n                    password: 'password123'\n                };\n                \n                const registerResponse = await fetch(`${API_BASE}/auth/register`, {\n                    method: 'POST',\n                    headers: { 'Content-Type': 'application/json' },\n                    body: JSON.stringify(registerData)\n                });\n                \n                const registerResult = await registerResponse.json();\n                if (!registerResult.status) {\n                    throw new Error('Registration failed: ' + registerResult.message);\n                }\n                \n                await addResult('‚úÖ User registered successfully', 'success');\n                testUserId = registerResult.data.user.id;\n                \n                // Step 2: Login\n                await addResult('Step 2: Logging in...', 'info');\n                const loginResponse = await fetch(`${API_BASE}/auth/login`, {\n                    method: 'POST',\n                    headers: { 'Content-Type': 'application/json' },\n                    body: JSON.stringify({\n                        email: registerData.email,\n                        password: registerData.password\n                    })\n                });\n                \n                const loginResult = await loginResponse.json();\n                if (!loginResult.status) {\n                    throw new Error('Login failed: ' + loginResult.message);\n                }\n                \n                testToken = loginResult.data.token;\n                await addResult('‚úÖ Login successful', 'success');\n                \n                // Step 3: Update personal info\n                await addResult('Step 3: Updating personal information...', 'info');\n                const personalInfo = {\n                    name: 'John Doe Test',\n                    email: registerData.email,\n                    phone: '+1-555-0123',\n                    address: '123 Main Street, Anytown, USA 12345',\n                    gender: 'Male',\n                    birthDate: '1990-05-15',\n                    maritalStatus: 'Married',\n                    profileImage: 'https://images.unsplash.com/photo-1507003211169-0a1dd7228f2d?w=150&h=150&fit=crop&crop=face'\n                };\n                \n                const updateResponse = await fetch(`${API_BASE}/auth/profile`, {\n                    method: 'PUT',\n                    headers: {\n                        'Content-Type': 'application/json',\n                        'Authorization': `Bearer ${testToken}`\n                    },\n                    body: JSON.stringify(personalInfo)\n                });\n                \n                const updateResult = await updateResponse.json();\n                if (!updateResult.status) {\n                    throw new Error('Profile update failed: ' + updateResult.message);\n                }\n                \n                await addResult('‚úÖ Personal information updated successfully', 'success');\n                \n                // Step 4: Verify in admin API\n                await addResult('Step 4: Verifying data in Admin Users API...', 'info');\n                const adminResponse = await fetch(`${API_BASE}/admin/users`);\n                const adminResult = await adminResponse.json();\n                \n                if (!adminResult.status) {\n                    throw new Error('Admin API failed: ' + adminResult.message);\n                }\n                \n                const testUser = adminResult.data.users.find(u => u.id === testUserId);\n                if (!testUser) {\n                    throw new Error('Test user not found in admin users list');\n                }\n                \n                await addResult('‚úÖ User found in Admin Users Management', 'success');\n                \n                // Display user card\n                await displayUserCard(testUser);\n                \n                await addResult('üéâ Complete flow test PASSED! Personal info flows from E-commerce My Profile to Dashboard Admin Users Management.', 'success');\n                \n            } catch (error) {\n                await addResult('‚ùå Test failed: ' + error.message, 'error');\n            }\n        }\n        \n        async function checkAdminUsers() {\n            try {\n                await addResult('Fetching users from Admin API...', 'info');\n                \n                const response = await fetch(`${API_BASE}/admin/users`);\n                const result = await response.json();\n                \n                if (!result.status) {\n                    throw new Error('Admin API failed: ' + result.message);\n                }\n                \n                await addResult(`‚úÖ Found ${result.data.users.length} users in system`, 'success');\n                \n                // Display users with personal info\n                for (const user of result.data.users.slice(0, 5)) { // Show first 5 users\n                    await displayUserCard(user);\n                }\n                \n            } catch (error) {\n                await addResult('‚ùå Error: ' + error.message, 'error');\n            }\n        }\n        \n        async function displayUserCard(user) {\n            const hasPersonalInfo = user.gender || user.birthDate || user.maritalStatus || user.profileImage;\n            \n            const cardHtml = `\n                <div class=\"user-card ${hasPersonalInfo ? 'success' : ''}\">\n                    <div class=\"user-info\">\n                        ${user.profileImage ? \n                            `<img src=\"${user.profileImage}\" alt=\"Profile\" class=\"profile-image\" onerror=\"this.style.display='none'\">` : \n                            `<div class=\"profile-image\" style=\"background: #e0e0e0; display: flex; align-items: center; justify-content: center; font-size: 20px;\">${user.name.charAt(0)}</div>`\n                        }\n                        <div>\n                            <h4>${user.name} (ID: ${user.id})</h4>\n                            <p><strong>Email:</strong> ${user.email}</p>\n                            <p><strong>Phone:</strong> ${user.phone || 'Not set'}</p>\n                            <p><strong>Gender:</strong> ${user.gender || 'Not set'}</p>\n                            <p><strong>Birth:</strong> ${user.birthDate ? new Date(user.birthDate).toLocaleDateString() : 'Not set'}</p>\n                            <p><strong>Status:</strong> ${user.maritalStatus || 'Not set'}</p>\n                            <p><strong>Role:</strong> ${user.role}</p>\n                        </div>\n                    </div>\n                </div>\n            `;\n            \n            await addResult(cardHtml, hasPersonalInfo ? 'success' : 'info');\n        }\n        \n        async function addResult(content, type = 'info') {\n            const resultsDiv = document.getElementById('results');\n            const section = document.createElement('div');\n            section.className = `section ${type}`;\n            section.innerHTML = content;\n            resultsDiv.appendChild(section);\n            \n            // Scroll to bottom\n            section.scrollIntoView({ behavior: 'smooth' });\n            \n            // Small delay for better UX\n            await new Promise(resolve => setTimeout(resolve, 500));\n        }\n        \n        function clearResults() {\n            document.getElementById('results').innerHTML = '';\n        }\n        \n        // Auto-run check on page load\n        window.onload = function() {\n            setTimeout(checkAdminUsers, 1000);\n        };\n    </script>\n</body>\n</html>
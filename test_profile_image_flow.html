<!DOCTYPE html>
<html>
<head>
    <title>Test Profile Image Flow</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .container { max-width: 800px; margin: 0 auto; }
        .section { margin: 20px 0; padding: 15px; border: 1px solid #ddd; border-radius: 5px; }
        .success { background: #d4edda; border-color: #c3e6cb; }
        .error { background: #f8d7da; border-color: #f5c6cb; }
        .info { background: #d1ecf1; border-color: #bee5eb; }
        button { background: #007bff; color: white; padding: 10px 15px; border: none; border-radius: 4px; cursor: pointer; margin: 5px; }
        button:hover { background: #0056b3; }
        .user-card { border: 1px solid #ddd; padding: 15px; margin: 10px 0; border-radius: 5px; display: flex; align-items: center; }
        .profile-image { width: 60px; height: 60px; border-radius: 50%; object-fit: cover; margin-right: 15px; border: 2px solid #007bff; }
        .no-image { width: 60px; height: 60px; border-radius: 50%; background: #e0e0e0; display: flex; align-items: center; justify-content: center; margin-right: 15px; font-size: 24px; color: #666; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üì∏ Profile Image Flow Test</h1>
        
        <div class="section info">
            <h3>üìã Test Flow:</h3>
            <ol>
                <li>User uploads profile image in E-commerce My Profile</li>
                <li>Image gets stored via upload API</li>
                <li>Profile image appears in Dashboard Admin Users Management</li>
            </ol>
        </div>
        
        <div class="section">
            <h3>üîß Test Controls</h3>
            <button onclick="testImageUpload()">üì§ Test Image Upload</button>
            <button onclick="checkUsersWithImages()">üë§ Check Users with Images</button>
            <button onclick="clearResults()">üóëÔ∏è Clear Results</button>
        </div>
        
        <div id="results"></div>
    </div>

    <script>
        const API_BASE = 'http://localhost:8191/api';
        
        async function testImageUpload() {
            await addResult('Testing image upload functionality...', 'info');
            
            try {\n                // Create a test image file (1x1 pixel PNG)\n                const canvas = document.createElement('canvas');\n                canvas.width = 100;\n                canvas.height = 100;\n                const ctx = canvas.getContext('2d');\n                \n                // Draw a simple test image\n                ctx.fillStyle = '#4CAF50';\n                ctx.fillRect(0, 0, 100, 100);\n                ctx.fillStyle = '#fff';\n                ctx.font = '20px Arial';\n                ctx.textAlign = 'center';\n                ctx.fillText('TEST', 50, 55);\n                \n                // Convert to blob\n                const blob = await new Promise(resolve => canvas.toBlob(resolve, 'image/png'));\n                \n                // Create FormData\n                const formData = new FormData();\n                formData.append('file', blob, 'test-profile.png');\n                \n                await addResult('Uploading test image...', 'info');\n                \n                const response = await fetch(`${API_BASE}/admin/upload-image`, {\n                    method: 'POST',\n                    body: formData\n                });\n                \n                const result = await response.json();\n                \n                if (result.status) {\n                    const imageUrl = `http://localhost:8191${result.data.imageUrl}`;\n                    await addResult(`‚úÖ Image uploaded successfully!<br>URL: ${imageUrl}`, 'success');\n                    \n                    // Show uploaded image\n                    await addResult(`<img src=\"${imageUrl}\" alt=\"Uploaded Test Image\" style=\"width: 100px; height: 100px; border-radius: 50%; border: 2px solid #4CAF50;\">`, 'success');\n                    \n                } else {\n                    await addResult('‚ùå Image upload failed: ' + result.message, 'error');\n                }\n                \n            } catch (error) {\n                await addResult('‚ùå Upload test failed: ' + error.message, 'error');\n            }\n        }\n        \n        async function checkUsersWithImages() {\n            try {\n                await addResult('Fetching users with profile images...', 'info');\n                \n                const response = await fetch(`${API_BASE}/admin/users`);\n                const result = await response.json();\n                \n                if (!result.status) {\n                    throw new Error('Admin API failed: ' + result.message);\n                }\n                \n                const usersWithImages = result.data.users.filter(user => user.profileImage && user.profileImage.trim() !== '');\n                const usersWithoutImages = result.data.users.filter(user => !user.profileImage || user.profileImage.trim() === '');\n                \n                await addResult(`‚úÖ Found ${usersWithImages.length} users with profile images`, 'success');\n                await addResult(`‚ÑπÔ∏è Found ${usersWithoutImages.length} users without profile images`, 'info');\n                \n                // Display users with images\n                if (usersWithImages.length > 0) {\n                    await addResult('<h4>üë§ Users with Profile Images:</h4>', 'success');\n                    for (const user of usersWithImages) {\n                        await displayUserWithImage(user, true);\n                    }\n                }\n                \n                // Display some users without images\n                if (usersWithoutImages.length > 0) {\n                    await addResult('<h4>üë§ Users without Profile Images (showing first 3):</h4>', 'info');\n                    for (const user of usersWithoutImages.slice(0, 3)) {\n                        await displayUserWithImage(user, false);\n                    }\n                }\n                \n            } catch (error) {\n                await addResult('‚ùå Error: ' + error.message, 'error');\n            }\n        }\n        \n        async function displayUserWithImage(user, hasImage) {\n            const imageElement = hasImage ? \n                `<img src=\"${user.profileImage}\" alt=\"${user.name}\" class=\"profile-image\" onerror=\"this.style.display='none'; this.nextElementSibling.style.display='flex';\">` +\n                `<div class=\"no-image\" style=\"display: none;\">${user.name.charAt(0)}</div>` :\n                `<div class=\"no-image\">${user.name.charAt(0)}</div>`;\n            \n            const cardHtml = `\n                <div class=\"user-card ${hasImage ? 'success' : ''}\">\n                    ${imageElement}\n                    <div>\n                        <h4>${user.name} (ID: ${user.id})</h4>\n                        <p><strong>Email:</strong> ${user.email}</p>\n                        <p><strong>Role:</strong> ${user.role}</p>\n                        ${hasImage ? `<p><strong>Image URL:</strong> <a href=\"${user.profileImage}\" target=\"_blank\">View Image</a></p>` : '<p><strong>Status:</strong> No profile image</p>'}\n                    </div>\n                </div>\n            `;\n            \n            await addResult(cardHtml, hasImage ? 'success' : 'info');\n        }\n        \n        async function addResult(content, type = 'info') {\n            const resultsDiv = document.getElementById('results');\n            const section = document.createElement('div');\n            section.className = `section ${type}`;\n            section.innerHTML = content;\n            resultsDiv.appendChild(section);\n            \n            // Scroll to bottom\n            section.scrollIntoView({ behavior: 'smooth' });\n            \n            // Small delay for better UX\n            await new Promise(resolve => setTimeout(resolve, 300));\n        }\n        \n        function clearResults() {\n            document.getElementById('results').innerHTML = '';\n        }\n        \n        // Auto-run check on page load\n        window.onload = function() {\n            setTimeout(checkUsersWithImages, 1000);\n        };\n    </script>\n</body>\n</html>